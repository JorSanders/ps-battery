name: Bump and Tag

on:
  push:
    branches:
      - main

jobs:
  bump:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust & cargo-edit
        run: |
          rustup update stable
          cargo install cargo-edit --quiet

      - name: Bump patch version
        id: bump
        shell: bash
        run: |
          cargo set-version --bump patch
          cargo update -p ps-battery
          git add Cargo.toml Cargo.lock
          new_version=$(awk -F '"' '
            /^\[package\]/ {in_package=1; next}
            /^\[/ {in_package=0}
            in_package && /^version/ {print $2; exit}
          ' Cargo.toml)

          if [ -z "$new_version" ]; then
            echo "❌ Failed to parse version from Cargo.toml"
            cat Cargo.toml
            exit 1
          fi

          echo "Detected new version: $new_version"
          git commit -m "chore(release): bump version to $new_version"
          git tag "v$new_version"
          echo "version=$new_version" >> $GITHUB_OUTPUT

      - name: Push commit and tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push origin HEAD:main
          git push origin "v${{ steps.bump.outputs.version }}"
